---
import Layout from '../../../layouts/Layout.astro';
import DashboardShell from '../../../components/DashboardShell.astro';
import { TICKET_CATEGORIES, TICKET_PRIORITIES } from '../../../types/tickets';

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect('/connexion');
}
---

<Layout title="Nouvelle Demande - PREVICARE EMPLOI">
  <DashboardShell title="Nouvelle Demande d'Assistance">
    
    <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-lg shadow-md">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-lg font-semibold text-gray-900">Décrivez votre demande</h2>
          <p class="text-sm text-gray-600 mt-1">Notre équipe vous répondra dans les plus brefs délais.</p>
        </div>

        <form id="ticketForm" class="p-6 space-y-6">
          <div>
            <label for="category" class="block text-sm font-medium text-gray-700 mb-2">
              Catégorie *
            </label>
            <select
              id="category"
              name="category"
              required
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
            >
              <option value="" disabled selected>Sélectionnez une catégorie</option>
              {Object.entries(TICKET_CATEGORIES).map(([key, value]) => (
                <option value={key}>{value.icon} {value.label}</option>
              ))}
            </select>
          </div>

          <div>
            <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">
              Sujet *
            </label>
            <input
              type="text"
              id="subject"
              name="subject"
              required
              maxlength="200"
              placeholder="Résumez votre demande en quelques mots"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary"
            />
          </div>

          <div>
            <label for="description" class="block text-sm font-medium text-gray-700 mb-2">
              Description détaillée *
            </label>
            <textarea
              id="description"
              name="description"
              required
              rows="6"
              placeholder="Décrivez votre situation en détail. Plus vous donnez d'informations, plus nous pourrons vous aider efficacement."
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none"
            ></textarea>
            <p class="mt-1 text-sm text-gray-500">Minimum 20 caractères</p>
          </div>

          <div>
            <label for="priority" class="block text-sm font-medium text-gray-700 mb-2">
              Priorité
            </label>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
              {Object.entries(TICKET_PRIORITIES).map(([key, value]) => (
                <label class={`relative flex items-center justify-center p-3 border rounded-lg cursor-pointer hover:border-primary transition-colors priority-option ${key === 'normal' ? 'border-primary bg-blue-50' : ''}`}>
                  <input 
                    type="radio" 
                    name="priority" 
                    value={key} 
                    class="sr-only"
                    checked={key === 'normal'}
                  />
                  <span class={`text-sm font-medium ${key === 'normal' ? 'text-primary' : 'text-gray-700'}`}>
                    {value.label}
                  </span>
                </label>
              ))}
            </div>
          </div>

          <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"></div>

          <div class="flex items-center justify-between pt-4">
            <a 
              href="/espace-employes/tickets"
              class="px-4 py-2 text-gray-600 hover:text-gray-800"
            >
              Annuler
            </a>
            <button
              type="submit"
              id="submitBtn"
              class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium"
            >
              <span id="btnText">Envoyer la demande</span>
              <svg id="btnSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
            </button>
          </div>
        </form>
      </div>
    </div>

  </DashboardShell>
</Layout>

<style>
  .priority-option:has(input:checked) {
    border-color: var(--color-primary, #3b82f6);
    background-color: rgb(239 246 255);
  }
  .priority-option:has(input:checked) span {
    color: var(--color-primary, #3b82f6);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('ticketForm') as HTMLFormElement;
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const errorMessage = document.getElementById('errorMessage');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const description = (document.getElementById('description') as HTMLTextAreaElement).value;
      if (description.length < 20) {
        if (errorMessage) {
          errorMessage.textContent = 'La description doit contenir au moins 20 caractères';
          errorMessage.classList.remove('hidden');
        }
        return;
      }

      if (submitBtn) submitBtn.setAttribute('disabled', 'true');
      if (btnText) btnText.textContent = 'Envoi en cours...';
      if (btnSpinner) btnSpinner.classList.remove('hidden');
      if (errorMessage) errorMessage.classList.add('hidden');

      const formData = new FormData(form);

      try {
        const response = await fetch('/api/tickets/create', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          window.location.href = `/espace-employes/tickets/${result.ticket.id}`;
        } else {
          throw new Error(result.message || 'Une erreur est survenue');
        }
      } catch (error: any) {
        if (errorMessage) {
          errorMessage.textContent = error.message || 'Une erreur est survenue';
          errorMessage.classList.remove('hidden');
        }
        if (submitBtn) submitBtn.removeAttribute('disabled');
        if (btnText) btnText.textContent = 'Envoyer la demande';
        if (btnSpinner) btnSpinner.classList.add('hidden');
      }
    });
  });
</script>
