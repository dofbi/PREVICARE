---
import Layout from '../../../layouts/Layout.astro';
import DashboardShell from '../../../components/DashboardShell.astro';
import { createClient } from '../../../lib/supabase';
import { TicketService } from '../../../lib/ticketService';
import { TICKET_CATEGORIES, TICKET_PRIORITIES, TICKET_STATUSES } from '../../../types/tickets';

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect('/connexion');
}

const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/espace-employes/tickets');
}

const supabase = createClient({ request: Astro.request, cookies: Astro.cookies });
const ticketService = new TicketService(supabase);

const ticket = await ticketService.getTicketById(id, user.id);

if (!ticket) {
  return Astro.redirect('/espace-employes/tickets');
}

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('fr-FR', {
    day: '2-digit',
    month: 'long',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

const categoryInfo = TICKET_CATEGORIES[ticket.category as keyof typeof TICKET_CATEGORIES];
const statusInfo = TICKET_STATUSES[ticket.status as keyof typeof TICKET_STATUSES];
const priorityInfo = TICKET_PRIORITIES[ticket.priority as keyof typeof TICKET_PRIORITIES];
---

<Layout title={`${ticket.ticket_number} - PREVICARE EMPLOI`}>
  <DashboardShell title="">
    
    <div class="max-w-4xl mx-auto space-y-6">
      <div class="flex items-center justify-between">
        <a 
          href="/espace-employes/tickets"
          class="inline-flex items-center text-gray-600 hover:text-primary"
        >
          <svg class="h-5 w-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
          Retour aux demandes
        </a>
        <span class="text-sm text-gray-500">{ticket.ticket_number}</span>
      </div>

      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-6 border-b border-gray-200">
          <div class="flex flex-wrap items-start justify-between gap-4">
            <div>
              <div class="flex items-center gap-2 mb-2">
                <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${categoryInfo?.color || 'bg-gray-100 text-gray-800'}`}>
                  {categoryInfo?.icon || ''} {categoryInfo?.label || ticket.category}
                </span>
                <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${statusInfo?.color || 'bg-gray-100 text-gray-800'}`}>
                  {statusInfo?.label || ticket.status}
                </span>
                {ticket.priority !== 'normal' && (
                  <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium ${priorityInfo?.color || ''}`}>
                    Priorité: {priorityInfo?.label || ticket.priority}
                  </span>
                )}
              </div>
              <h1 class="text-xl font-bold text-gray-900">{ticket.subject}</h1>
            </div>
            <div class="text-right text-sm text-gray-500">
              <p>Créé le {formatDate(ticket.created_at)}</p>
              {ticket.updated_at !== ticket.created_at && (
                <p>Mis à jour le {formatDate(ticket.updated_at)}</p>
              )}
            </div>
          </div>
        </div>

        <div class="p-6">
          <div class="space-y-6">
            {ticket.messages && ticket.messages.length > 0 ? (
              ticket.messages.map((message: any) => {
                const isCurrentUser = message.sender_id === user.id;
                return (
                  <div class={`flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`}>
                    <div class={`max-w-[80%] ${isCurrentUser ? 'order-2' : ''}`}>
                      <div class="flex items-center gap-2 mb-1">
                        <span class="text-sm font-medium text-gray-900">
                          {message.sender?.first_name || 'Utilisateur'} {message.sender?.last_name || ''}
                        </span>
                        <span class="text-xs text-gray-500">
                          {formatDate(message.created_at)}
                        </span>
                      </div>
                      <div class={`p-4 rounded-lg ${isCurrentUser ? 'bg-primary text-white' : 'bg-gray-100 text-gray-800'}`}>
                        <p class="whitespace-pre-wrap">{message.message}</p>
                      </div>
                    </div>
                  </div>
                );
              })
            ) : (
              <div class="text-center py-8">
                <p class="text-gray-500">Aucun message pour le moment</p>
              </div>
            )}
          </div>
        </div>

        {(ticket.status === 'open' || ticket.status === 'in_progress') && (
          <div class="p-6 border-t border-gray-200 bg-gray-50">
            <form id="replyForm" class="space-y-4">
              <input type="hidden" name="ticketId" value={ticket.id} />
              <div>
                <label for="message" class="block text-sm font-medium text-gray-700 mb-2">
                  Votre réponse
                </label>
                <textarea
                  id="message"
                  name="message"
                  required
                  rows="4"
                  placeholder="Écrivez votre message..."
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none"
                ></textarea>
              </div>
              <div id="errorMessage" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg"></div>
              <div class="flex justify-end">
                <button
                  type="submit"
                  id="submitBtn"
                  class="inline-flex items-center px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium"
                >
                  <span id="btnText">Envoyer</span>
                  <svg id="btnSpinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </button>
              </div>
            </form>
          </div>
        )}

        {(ticket.status === 'resolved' || ticket.status === 'closed') && (
          <div class="p-6 border-t border-gray-200 bg-green-50 text-center">
            <svg class="mx-auto h-12 w-12 text-green-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <p class="text-green-800 font-medium">Cette demande a été résolue</p>
            <p class="text-green-600 text-sm mt-1">Merci d'avoir utilisé nos services</p>
          </div>
        )}
      </div>
    </div>

  </DashboardShell>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('replyForm') as HTMLFormElement;
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const btnSpinner = document.getElementById('btnSpinner');
    const errorMessage = document.getElementById('errorMessage');

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (submitBtn) submitBtn.setAttribute('disabled', 'true');
      if (btnText) btnText.textContent = 'Envoi...';
      if (btnSpinner) btnSpinner.classList.remove('hidden');
      if (errorMessage) errorMessage.classList.add('hidden');

      const formData = new FormData(form);

      try {
        const response = await fetch('/api/tickets/reply', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          window.location.reload();
        } else {
          throw new Error(result.message || 'Une erreur est survenue');
        }
      } catch (error: any) {
        if (errorMessage) {
          errorMessage.textContent = error.message || 'Une erreur est survenue';
          errorMessage.classList.remove('hidden');
        }
        if (submitBtn) submitBtn.removeAttribute('disabled');
        if (btnText) btnText.textContent = 'Envoyer';
        if (btnSpinner) btnSpinner.classList.add('hidden');
      }
    });
  });
</script>
