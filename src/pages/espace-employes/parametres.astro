
---
import Layout from '../../layouts/Layout.astro';
import DashboardShell from '../../components/DashboardShell.astro';
import { createClient } from '../../lib/supabase';

const { user } = Astro.locals;

// Vérifier si l'utilisateur est connecté
if (!user) {
  return Astro.redirect('/connexion');
}

// Vérifier si l'utilisateur a le bon rôle
const userRole = user.user_metadata?.role;
if (userRole !== 'employee') {
  return Astro.redirect('/connexion');
}

const supabase = createClient({
  request: Astro.request,
  cookies: Astro.cookies,
});

// Récupérer les données du profil
const { data: profile } = await supabase
  .from('profiles')
  .select('*')
  .eq('id', user.id)
  .single();

// Récupérer les détails de l'employé
const { data: employeeDetails } = await supabase
  .from('employee_details')
  .select('*')
  .eq('id', user.id)
  .single();

// Vérifier si le profil est complet
const isProfileComplete = profile && 
  profile.first_name && 
  profile.last_name && 
  profile.email && 
  profile.phone && 
  profile.address && 
  profile.country;

const countries = [
  "Sénégal", "France", "Côte d'Ivoire", "Mali", "Burkina Faso", "Niger", 
  "Guinée", "Mauritanie", "Bénin", "Togo", "Ghana", "Cameroun", "Gabon"
];

const contractTypes = [
  "CDI", "CDD", "Stagiaire", "Apprenti", "Consultant", "Freelance"
];

const sectors = [
  "Agriculture", "Industrie", "Services", "Commerce", "Santé", "Éducation",
  "Transport", "Télécommunications", "Banque", "Assurance", "BTP", "Autre"
];
---

<Layout title="Paramètres - PREVICARE EMPLOI">
  <DashboardShell title="Paramètres du profil">
    
    <!-- Alerte profil incomplet -->
    {!isProfileComplete && (
      <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-yellow-800">Profil incomplet</h3>
            <div class="mt-1 text-sm text-yellow-700">
              <p>Veuillez compléter vos informations personnelles pour accéder à tous les services.</p>
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- Onglets -->
    <div class="mt-4 sm:mt-6">
      <div class="bg-muted p-1 rounded-lg w-full grid grid-cols-2">
        <button
          class="tab-button active flex items-center justify-center whitespace-nowrap rounded-md px-2 py-2 text-xs sm:text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-background text-foreground shadow"
          data-tab="personal"
        >
          Profil Personnel
        </button>
        <button
          class="tab-button flex items-center justify-center whitespace-nowrap rounded-md px-2 py-2 text-xs sm:text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"
          data-tab="professional"
        >
          Carrière & Emploi
        </button>
      </div>

      <!-- Contenu des onglets -->
      <div class="mt-4 space-y-4">
        <!-- Onglet Informations personnelles -->
        <div id="personal-tab" class="tab-content">
          <div class="bg-white rounded-lg border shadow-sm">
            <div class="p-6 border-b">
              <h3 class="text-lg font-semibold">Profil Personnel</h3>
              <p class="text-sm text-muted-foreground">Mettez à jour vos informations personnelles et de contact.</p>
            </div>
            <form id="personal-form" class="p-6 space-y-6">
              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label for="first_name" class="block text-sm font-medium text-gray-700">Prénom *</label>
                  <input 
                    type="text" 
                    id="first_name" 
                    name="first_name" 
                    value={profile?.first_name || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                    required
                  />
                </div>
                
                <div>
                  <label for="last_name" class="block text-sm font-medium text-gray-700">Nom *</label>
                  <input 
                    type="text" 
                    id="last_name" 
                    name="last_name" 
                    value={profile?.last_name || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                    required
                  />
                </div>
                
                <div>
                  <label for="email" class="block text-sm font-medium text-gray-700">Email *</label>
                  <input 
                    type="email" 
                    id="email" 
                    name="email" 
                    value={profile?.email || user.email || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                    required
                  />
                </div>
                
                <div>
                  <label for="phone" class="block text-sm font-medium text-gray-700">Téléphone</label>
                  <input 
                    type="tel" 
                    id="phone" 
                    name="phone" 
                    value={profile?.phone || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  />
                </div>
                
                <div class="sm:col-span-2">
                  <label for="address" class="block text-sm font-medium text-gray-700">Adresse</label>
                  <textarea 
                    id="address" 
                    name="address" 
                    rows="3"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  >{profile?.address || ''}</textarea>
                </div>
                
                <div>
                  <label for="country" class="block text-sm font-medium text-gray-700">Pays</label>
                  <select 
                    id="country" 
                    name="country" 
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  >
                    <option value="">-- Choisir un pays --</option>
                    {countries.map(country => (
                      <option value={country} selected={profile?.country === country}>{country}</option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label for="organization" class="block text-sm font-medium text-gray-700">Organisation/Entreprise</label>
                  <input 
                    type="text" 
                    id="organization" 
                    name="organization" 
                    value={profile?.organization || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  />
                </div>
              </div>
              
              <div class="flex justify-end">
                <button 
                  type="submit" 
                  class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
                >
                  Sauvegarder
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Onglet Informations professionnelles -->
        <div id="professional-tab" class="tab-content hidden">
          <div class="bg-white rounded-lg border shadow-sm">
            <div class="p-6 border-b">
              <h3 class="text-lg font-semibold">Carrière & Emploi</h3>
              <p class="text-sm text-muted-foreground">Gérez vos informations d'emploi, IPRES et détails professionnels.</p>
            </div>
            <form id="professional-form" class="p-6 space-y-6">
              <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                <div>
                  <label class="flex items-center">
                    <input 
                      type="checkbox" 
                      name="is_expatriate" 
                      value="true"
                      checked={employeeDetails?.is_expatriate || false}
                      class="rounded border-gray-300 text-primary focus:ring-primary"
                    />
                    <span class="ml-2 text-sm text-gray-700">Je suis expatrié</span>
                  </label>
                </div>
                
                <div>
                  <label for="ipres_number" class="block text-sm font-medium text-gray-700">Numéro IPRES</label>
                  <input 
                    type="text" 
                    id="ipres_number" 
                    name="ipres_number" 
                    value={employeeDetails?.ipres_number || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  />
                </div>
                
                <div>
                  <label for="medical_insurer_name" class="block text-sm font-medium text-gray-700">Assureur médical</label>
                  <input 
                    type="text" 
                    id="medical_insurer_name" 
                    name="medical_insurer_name" 
                    value={employeeDetails?.medical_insurer_name || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  />
                </div>
                
                <div>
                  <label for="sector" class="block text-sm font-medium text-gray-700">Secteur d'activité</label>
                  <select 
                    id="sector" 
                    name="sector" 
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  >
                    <option value="">-- Choisir un secteur --</option>
                    {sectors.map(sector => (
                      <option value={sector} selected={employeeDetails?.sector === sector}>{sector}</option>
                    ))}
                  </select>
                </div>
                
                <div>
                  <label for="hire_date" class="block text-sm font-medium text-gray-700">Date d'embauche</label>
                  <input 
                    type="date" 
                    id="hire_date" 
                    name="hire_date" 
                    value={employeeDetails?.hire_date || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  />
                </div>
                
                <div>
                  <label for="contract_type" class="block text-sm font-medium text-gray-700">Type de contrat</label>
                  <select 
                    id="contract_type" 
                    name="contract_type" 
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  >
                    <option value="">-- Choisir un type --</option>
                    {contractTypes.map(type => (
                      <option value={type} selected={employeeDetails?.contract_type === type}>{type}</option>
                    ))}
                  </select>
                </div>
                
                <div class="sm:col-span-2">
                  <label for="current_position" class="block text-sm font-medium text-gray-700">Poste actuel</label>
                  <input 
                    type="text" 
                    id="current_position" 
                    name="current_position" 
                    value={employeeDetails?.current_position || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  />
                </div>
                
                <div class="sm:col-span-2">
                  <label for="employer_name" class="block text-sm font-medium text-gray-700">Nom de l'employeur</label>
                  <input 
                    type="text" 
                    id="employer_name" 
                    name="employer_name" 
                    value={employeeDetails?.employer_name || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  />
                </div>
                
                <div>
                  <label for="employer_ceo_contact" class="block text-sm font-medium text-gray-700">Contact PDG</label>
                  <input 
                    type="text" 
                    id="employer_ceo_contact" 
                    name="employer_ceo_contact" 
                    value={employeeDetails?.employer_ceo_contact || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  />
                </div>
                
                <div>
                  <label for="employer_hr_contact" class="block text-sm font-medium text-gray-700">Contact RH</label>
                  <input 
                    type="text" 
                    id="employer_hr_contact" 
                    name="employer_hr_contact" 
                    value={employeeDetails?.employer_hr_contact || ''}
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary"
                  />
                </div>
              </div>
              
              <div class="flex justify-end">
                <button 
                  type="submit" 
                  class="px-4 py-2 text-sm font-medium text-white bg-primary rounded-md hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary"
                >
                  Sauvegarder
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Messages d'erreur/succès -->
    <div id="message" class="hidden mt-4 p-4 rounded-md">
      <p id="message-text"></p>
    </div>

    <script>
      import { actions } from 'astro:actions';

      document.addEventListener('DOMContentLoaded', function() {
        // Gestion des onglets
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(tab => {
          tab.addEventListener('click', function(this: HTMLElement) {
            const targetTab = this.getAttribute('data-tab');

            // Remove active class from all buttons
            tabButtons.forEach(btn => {
              btn.classList.remove('active', 'bg-background', 'text-foreground', 'shadow');
            });

            // Add active class to clicked button
            this.classList.add('active', 'bg-background', 'text-foreground', 'shadow');

            // Hide all tab contents
            tabContents.forEach(content => {
              content.classList.add('hidden');
            });

            // Show target tab content
            const targetContent = document.getElementById(targetTab + '-tab');
            if (targetContent) {
              targetContent.classList.remove('hidden');
            }
          });
        });

        // Gestion du formulaire personnel
        const personalForm = document.getElementById('personal-form') as HTMLFormElement;
        personalForm?.addEventListener('submit', async (event) => {
          event.preventDefault();
          const formData = new FormData(personalForm);
          
          try {
            const result = await actions.profile.updateProfile(formData);
            if (result.data?.success) {
              showMessage('Profil mis à jour avec succès', 'success');
              setTimeout(() => window.location.reload(), 1500);
            } else {
              showMessage(result.data?.message || 'Erreur lors de la mise à jour', 'error');
            }
          } catch (error: any) {
            showMessage('Une erreur inattendue s\'est produite', 'error');
          }
        });

        // Gestion du formulaire professionnel
        const professionalForm = document.getElementById('professional-form') as HTMLFormElement;
        professionalForm?.addEventListener('submit', async (event) => {
          event.preventDefault();
          const formData = new FormData(professionalForm);
          
          // Ajouter des logs pour debug
          console.log('Soumission du formulaire professionnel');
          for (let [key, value] of formData.entries()) {
            console.log(key, value);
          }
          
          try {
            const result = await actions.profile.updateEmployeeDetails(formData);
            console.log('Résultat:', result);
            if (result.data?.success) {
              showMessage('Informations professionnelles mises à jour avec succès', 'success');
            } else {
              showMessage(result.data?.message || result.error?.message || 'Erreur lors de la mise à jour', 'error');
            }
          } catch (error: any) {
            console.error('Erreur:', error);
            showMessage('Une erreur inattendue s\'est produite', 'error');
          }
        });

        function showMessage(text: string, type: 'success' | 'error') {
          const messageDiv = document.getElementById('message') as HTMLElement;
          const messageText = document.getElementById('message-text') as HTMLElement;
          
          messageText.textContent = text;
          messageDiv.classList.remove('hidden', 'bg-green-50', 'bg-red-50', 'text-green-800', 'text-red-800');
          
          if (type === 'success') {
            messageDiv.classList.add('bg-green-50', 'text-green-800');
          } else {
            messageDiv.classList.add('bg-red-50', 'text-red-800');
          }
          
          setTimeout(() => {
            messageDiv.classList.add('hidden');
          }, 5000);
        }
      });
    </script>
  </DashboardShell>
</Layout>
