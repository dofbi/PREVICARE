---
import Layout from '../layouts/Layout.astro';
import { actions } from 'astro:actions';

const { user } = Astro.locals;

// R√©cup√©rer le param√®tre redirect pour apr√®s inscription
const redirectParam = Astro.url.searchParams.get('redirect');

// Si l'utilisateur est d√©j√† connect√©, le rediriger vers sa page (ou le redirect demand√©)
if (user) {
  if (redirectParam) {
    return Astro.redirect(redirectParam);
  }
  
  const userRole = user.user_metadata?.role;

  if (userRole === 'employee') {
    return Astro.redirect(user.user_metadata?.is_expatriate ? '/espace-expatries' : '/espace-employes');
  } else if (userRole === 'employer') {
    return Astro.redirect('/espace-employeurs');
  } else if (userRole === 'delegate') {
    return Astro.redirect('/espace-delegues');
  }

  return Astro.redirect('/dashboard');
}

// Gestion du r√©sultat de l'action d'inscription
const result = Astro.getActionResult(actions.auth.signUp);

// Construire l'URL de connexion avec le redirect
const connexionUrl = redirectParam ? `/connexion?redirect=${encodeURIComponent(redirectParam)}` : '/connexion';
---

<Layout title="Inscription - PREVICARE EMPLOI">
  <main class="flex min-h-screen items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
    <div class="w-full max-w-md">
      <div class="text-center mb-8">
        <a href="/" class="inline-block">
          <h1 class="text-3xl font-bold text-primary">PREVICARE EMPLOI</h1>
        </a>
        <p class="mt-2 text-gray-600">Votre partenaire RH au S√©n√©gal</p>
      </div>

      <div class="w-full">
        <!-- Tabs -->
        <div class="grid w-full grid-cols-2 mb-8 bg-gray-100 p-1 rounded-lg">
          <a
            href={connexionUrl}
            class="tab-button text-gray-600 px-4 py-2 text-sm font-medium rounded-md transition-all text-center"
          >
            Connexion
          </a>
          <button
            class="tab-button active bg-white text-primary px-4 py-2 text-sm font-medium rounded-md transition-all"
            data-tab="register"
          >
            Inscription
          </button>
        </div>

        <!-- Affichage des messages de succ√®s et d'erreur -->
        {(result?.error || (result?.data && !result.data.success)) && (
          <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
            <div class="flex">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-red-800">
                  Erreur lors de l'inscription
                </h3>
                <div class="mt-1 text-sm text-red-700">
                  <p>
                    {result?.error?.message || result?.data?.message || 'Une erreur s\'est produite lors de l\'inscription.'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {(result?.data && result.data.success) && (
          <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-md">
            <div class="flex items-start">
              <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
              </div>
              <div class="ml-3">
                <h3 class="text-sm font-medium text-green-800">
                  Inscription r√©ussie !
                </h3>
                <div class="mt-1 text-sm text-green-700">
                  <p>{result.data.message}</p>
                  <div class="mt-3 p-3 bg-green-100 rounded-md">
                    <p class="text-green-800 text-sm font-medium">üìß V√©rifiez votre bo√Æte email</p>
                    <p class="text-green-700 text-xs mt-1">
                      Un email de confirmation a √©t√© envoy√© √† votre adresse.
                      Cliquez sur le lien de validation pour activer votre compte.
                    </p>
                    <p class="text-green-600 text-xs mt-2">
                      üí° Pensez √† v√©rifier vos spams si vous ne recevez pas l'email dans les prochaines minutes.
                    </p>
                  </div>
                  <div class="mt-3 text-center">
                    <a href="/connexion" class="inline-flex items-center px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors">
                      Se connecter maintenant
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        <!-- Register Tab Content -->
        <div id="register-tab" class="tab-content">
          <div class="bg-white rounded-lg shadow-md">
            <div class="p-6">
              <h2 class="text-2xl font-bold text-center mb-2">Cr√©er votre compte</h2>
              <p class="text-gray-600 text-center mb-6">Rejoignez PREVICARE EMPLOI en quelques √©tapes</p>

              <form method="POST" action={actions.auth.signUp} class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                  <div class="space-y-2">
                    <label for="firstName" class="block text-sm font-medium text-gray-700">Pr√©nom *</label>
                    <input
                      type="text"
                      id="firstName"
                      name="firstName"
                      placeholder="Votre pr√©nom"
                      class="flex h-10 w-full rounded-md border border-gray-300 bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                      required
                    />
                  </div>
                  <div class="space-y-2">
                    <label for="lastName" class="block text-sm font-medium text-gray-700">Nom *</label>
                    <input
                      type="text"
                      id="lastName"
                      name="lastName"
                      placeholder="Votre nom"
                      class="flex h-10 w-full rounded-md border border-gray-300 bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                      required
                    />
                  </div>
                </div>

                <div class="space-y-2">
                  <label for="email" class="block text-sm font-medium text-gray-700">Email *</label>
                  <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                      <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"/>
                      </svg>
                    </div>
                    <input
                      type="email"
                      id="email"
                      name="email"
                      placeholder="nom@exemple.com"
                      class="flex h-10 w-full rounded-md border border-gray-300 bg-background pl-10 px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                      required
                    />
                  </div>
                </div>

                <div class="space-y-2">
                  <label for="phone" class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
                  <input
                    type="tel"
                    id="phone"
                    name="phone"
                    placeholder="+221 XX XXX XX XX"
                    class="flex h-10 w-full rounded-md border border-gray-300 bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                  />
                </div>

                <div class="space-y-2">
                  <label for="userType" class="block text-sm font-medium text-gray-700">Type d'utilisateur *</label>
                  <select
                    id="userType"
                    name="userType"
                    class="flex h-10 w-full rounded-md border border-gray-300 bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                    required
                  >
                    <option value="" disabled selected>S√©lectionnez votre profil</option>
                    <option value="employee">Employ√© du secteur priv√©</option>
                    <option value="employer">Employeur / RH</option>
                    <option value="delegate">D√©l√©gu√© du personnel</option>
                  </select>
                  <p class="text-xs text-gray-500">
                    S√©lectionnez le profil qui correspond le mieux √† votre situation
                  </p>
                </div>

                <div class="space-y-2" id="expatriate-field" style="display: none;">
                  <label class="flex items-start space-x-3">
                    <input
                      type="checkbox"
                      id="isExpatriate"
                      name="isExpatriate"
                      value="true"
                      class="rounded border-gray-300 mt-1 text-primary focus:ring-primary"
                    />
                    <div>
                      <span class="text-sm font-medium text-gray-700">
                        Je suis expatri√©(e) au S√©n√©gal
                      </span>
                      <p class="text-xs text-gray-500 mt-1">
                        Cochez cette case si vous √™tes un √©tranger travaillant au S√©n√©gal (employ√©, employeur, d√©l√©gu√©). Cela nous permettra de vous proposer des services adapt√©s √† votre statut d'expatri√©.
                      </p>
                    </div>
                  </label>
                </div>

                <div class="space-y-2">
                  <label for="company" class="block text-sm font-medium text-gray-700">Entreprise</label>
                  <input
                    type="text"
                    id="company"
                    name="company"
                    placeholder="Nom de votre entreprise (optionnel)"
                    class="flex h-10 w-full rounded-md border border-gray-300 bg-background px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                  />
                </div>

                <div class="space-y-2">
                  <label for="password" class="block text-sm font-medium text-gray-700">Mot de passe *</label>
                  <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                      <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                      </svg>
                    </div>
                    <input
                      type="password"
                      id="password"
                      name="password"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      class="flex h-10 w-full rounded-md border border-gray-300 bg-background pl-10 pr-10 px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                      required
                      minlength="8"
                    />
                    <button
                      type="button"
                      class="absolute inset-y-0 right-0 flex items-center pr-3 toggle-password"
                      data-target="password"
                    >
                      <svg class="h-5 w-5 text-gray-400 eye-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                      </svg>
                      <svg class="h-5 w-5 text-gray-400 eye-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
                      </svg>
                    </button>
                  </div>

                  <!-- Recommandations de mot de passe -->
                  <div id="password-requirements" class="mt-2 p-3 bg-gray-50 rounded-md border hidden">
                    <p class="text-sm font-medium text-gray-700 mb-2">Exigences du mot de passe :</p>
                    <div class="space-y-1">
                      <div id="req-length" class="flex items-center text-xs">
                        <svg class="h-4 w-4 mr-2 req-icon" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="req-text">Au moins 8 caract√®res</span>
                      </div>
                      <div id="req-uppercase" class="flex items-center text-xs">
                        <svg class="h-4 w-4 mr-2 req-icon" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="req-text">Au moins une majuscule</span>
                      </div>
                      <div id="req-lowercase" class="flex items-center text-xs">
                        <svg class="h-4 w-4 mr-2 req-icon" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="req-text">Au moins une minuscule</span>
                      </div>
                      <div id="req-number" class="flex items-center text-xs">
                        <svg class="h-4 w-4 mr-2 req-icon" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="req-text">Au moins un chiffre</span>
                      </div>
                      <div id="req-special" class="flex items-center text-xs">
                        <svg class="h-4 w-4 mr-2 req-icon" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="req-text">Au moins un caract√®re sp√©cial (!@#$%^&*)</span>
                      </div>
                    </div>

                    <!-- Indicateur de force -->
                    <div class="mt-3">
                      <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-medium text-gray-600">Force du mot de passe</span>
                        <span id="password-strength-text" class="text-xs font-medium">Faible</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="password-strength-bar" class="h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="space-y-2">
                  <label for="confirmPassword" class="block text-sm font-medium text-gray-700">Confirmer le mot de passe *</label>
                  <div class="relative">
                    <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                      <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                      </svg>
                    </div>
                    <input
                      type="password"
                      id="confirmPassword"
                      name="confirmPassword"
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      class="flex h-10 w-full rounded-md border border-gray-300 bg-background pl-10 pr-10 px-3 py-2 text-sm ring-offset-background focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
                      required
                    />
                    <button
                      type="button"
                      class="absolute inset-y-0 right-0 flex items-center pr-3 toggle-password"
                      data-target="confirmPassword"
                    >
                      <svg class="h-5 w-5 text-gray-400 eye-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                      </svg>
                      <svg class="h-5 w-5 text-gray-400 eye-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="space-y-4">
                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      id="terms"
                      name="terms"
                      class="rounded border-gray-300 mt-1"
                      required
                    />
                    <label for="terms" class="ml-2 text-sm text-gray-600">
                      J'accepte les <a href="/conditions-utilisation" class="text-primary hover:underline">conditions d'utilisation</a>
                      et la <a href="/politique-confidentialite" class="text-primary hover:underline">politique de confidentialit√©</a>
                    </label>
                  </div>

                  <div class="flex items-start">
                    <input
                      type="checkbox"
                      id="newsletter"
                      name="newsletter"
                      class="rounded border-gray-300 mt-1"
                    />
                    <label for="newsletter" class="ml-2 text-sm text-gray-600">
                      J'accepte de recevoir des informations sur les services PREVICARE EMPLOI
                    </label>
                  </div>
                </div>

                <div class="pt-4">
                  <button
                    type="submit"
                    class="w-full bg-primary text-white hover:bg-primary-dark py-3 px-4 rounded-md font-semibold transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                    id="submitBtn"
                  >
                    <span id="submitBtnText">Cr√©er mon compte</span>
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <p class="mt-4 text-center text-sm text-gray-600">
          Vous avez d√©j√† un compte ?
          <a href="/connexion" class="text-primary hover:underline font-medium">
            Se connecter
          </a>
        </p>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Password toggle functionality
      const toggleButtons = document.querySelectorAll('.toggle-password');

      toggleButtons.forEach(button => {
        button.addEventListener('click', function(this: HTMLElement) {
          const targetId = this.getAttribute('data-target');
          const eyeOpen = this.querySelector('.eye-open');
          const eyeClosed = this.querySelector('.eye-closed');
          const targetInput = document.getElementById(targetId!) as HTMLInputElement;
          if (targetInput?.type === 'password') {
            targetInput.type = 'text';
            if(eyeOpen && eyeClosed) {
              eyeOpen.classList.add('hidden');
              eyeClosed.classList.remove('hidden');
            }
          } else {
            targetInput.type = 'password';
            if(eyeOpen && eyeClosed) {
              eyeOpen.classList.remove('hidden');
              eyeClosed.classList.add('hidden');
            }
          }
        });
      });

      // Password validation en temps r√©el
      const passwordInput = document.getElementById('password') as HTMLInputElement | null;
      const passwordRequirements = document.getElementById('password-requirements');
      const strengthBar = document.getElementById('password-strength-bar');
      const strengthText = document.getElementById('password-strength-text');

      // Fonction pour valider le mot de passe
      function validatePassword(password: string) {
        const requirements = {
          length: password.length >= 8,
          uppercase: /[A-Z]/.test(password),
          lowercase: /[a-z]/.test(password),
          number: /\d/.test(password),
          special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
        };

        return requirements;
      }

      // Fonction pour calculer la force du mot de passe
      function calculateStrength(requirements: { [key: string]: boolean }) {
        const validCount = Object.values(requirements).filter(Boolean).length;
        return (validCount / 5) * 100;
      }

      // Fonction pour mettre √† jour l'affichage des exigences
      function updateRequirements(requirements: { [key: string]: boolean }) {
        const reqElements: { [key: string]: HTMLElement | null } = {
          length: document.getElementById('req-length'),
          uppercase: document.getElementById('req-uppercase'),
          lowercase: document.getElementById('req-lowercase'),
          number: document.getElementById('req-number'),
          special: document.getElementById('req-special')
        };

        Object.keys(requirements).forEach(req => {
          const element = reqElements[req];
          if (element) {
            const icon = element.querySelector('.req-icon');
            const text = element.querySelector('.req-text');

            if (requirements[req]) {
              // Exigence remplie - vert
              element.className = 'flex items-center text-xs text-green-600';
              if(icon) icon.className = 'h-4 w-4 mr-2 req-icon text-green-600';
              if(text) text.className = 'req-text line-through';
            } else {
              // Exigence non remplie - rouge
              element.className = 'flex items-center text-xs text-red-600';
              if(icon) icon.className = 'h-4 w-4 mr-2 req-icon text-red-600';
              if(text) text.className = 'req-text';
            }
          }
        });
      }

      // Fonction pour mettre √† jour la barre de force
      function updateStrengthBar(strength: number) {
        if (strengthBar) strengthBar.style.width = strength + '%';
        if (strengthText) {
          if (strength < 40) {
            if (strengthBar) strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-red-500';
            strengthText.textContent = 'Faible';
            strengthText.className = 'text-xs font-medium text-red-600';
          } else if (strength < 70) {
            if (strengthBar) strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-yellow-500';
            strengthText.textContent = 'Moyen';
            strengthText.className = 'text-xs font-medium text-yellow-600';
          } else if (strength < 90) {
            if (strengthBar) strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-blue-500';
            strengthText.textContent = 'Bon';
            strengthText.className = 'text-xs font-medium text-blue-600';
          } else {
            if (strengthBar) strengthBar.className = 'h-2 rounded-full transition-all duration-300 bg-green-500';
            strengthText.textContent = 'Tr√®s fort';
            strengthText.className = 'text-xs font-medium text-green-600';
          }
        }
      }

      // √âv√©nement d'entr√©e pour le mot de passe
      if (passwordInput) {
        passwordInput.addEventListener('input', function(this: HTMLInputElement) {
          const password = this.value;

          if (password.length > 0) {
            if (passwordRequirements) passwordRequirements.classList.remove('hidden');

            const requirements = validatePassword(password);
            const strength = calculateStrength(requirements);

            updateRequirements(requirements);
            updateStrengthBar(strength);
          } else {
            if (passwordRequirements) passwordRequirements.classList.add('hidden');
          }
        });

        // Masquer les exigences quand le champ perd le focus (optionnel)
        passwordInput.addEventListener('blur', function() {
          if (this.value.length === 0) {
            if (passwordRequirements) passwordRequirements.classList.add('hidden');
          }
        });
      }

      // Show/hide expatriate field based on user type
      const userTypeSelect = document.getElementById('userType') as HTMLSelectElement | null;
      const expatriateField = document.getElementById('expatriate-field');

      function updateExpatriateVisibility() {
        // Afficher le champ expatri√© pour tous les types d'utilisateurs sauf si aucun n'est s√©lectionn√©
        if (userTypeSelect && userTypeSelect.value && userTypeSelect.value !== '') {
          if (expatriateField) expatriateField.style.display = 'block';
          if (expatriateField) expatriateField.classList.add('animate-fadeIn');
        } else {
          if (expatriateField) expatriateField.style.display = 'none';
          if (expatriateField) expatriateField.classList.remove('animate-fadeIn');
        }
      }

      if (userTypeSelect) {
        userTypeSelect.addEventListener('change', updateExpatriateVisibility);
      }

      // Initialize on page load - only if a value is already selected
      if (userTypeSelect && userTypeSelect.value) {
        updateExpatriateVisibility();
      }

      // Form validation
      const form = document.querySelector('form');
      const submitBtn = document.getElementById('submitBtn');
      const confirmPasswordInput = document.getElementById('confirmPassword') as HTMLInputElement | null;

      // Fonction pour afficher les erreurs
      function showError(message: string) {
        alert(message); // Dans une application r√©elle, utiliser une notification plus √©l√©gante
      }

      // Validation en temps r√©el pour la correspondance des mots de passe
      function checkPasswordMatch() {
        const password = passwordInput?.value;
        const confirmPassword = confirmPasswordInput?.value;

        if (confirmPassword && password !== confirmPassword) {
          if (confirmPasswordInput) {
            confirmPasswordInput.setCustomValidity('Les mots de passe ne correspondent pas');
            confirmPasswordInput.classList.add('border-red-500');
          }
        } else {
          if (confirmPasswordInput) {
            confirmPasswordInput.setCustomValidity('');
            confirmPasswordInput.classList.remove('border-red-500');
          }
        }
      }

      // Validation en temps r√©el
      if (passwordInput) passwordInput.addEventListener('input', checkPasswordMatch);
      if (confirmPasswordInput) confirmPasswordInput.addEventListener('input', checkPasswordMatch);

      // Validation des champs requis √† la perte de focus
      document.querySelectorAll('input[required], select[required]').forEach(field => {
          field.addEventListener('blur', function(this: HTMLInputElement | HTMLSelectElement) {
            if (this.value.length === 0) {
              this.classList.add('border-red-500'); // Ajouter une bordure rouge pour indiquer le champ requis
            } else {
              this.classList.remove('border-red-500');
            }
          });
          // R√©appliquer la validation lors de la saisie
          field.addEventListener('input', function(this: HTMLInputElement | HTMLSelectElement) {
            if (this.value.length > 0) {
              this.classList.remove('border-red-500');
            }
          });
      });


      // Gestion de la soumission du formulaire
      if (form && submitBtn && passwordInput && confirmPasswordInput) {
        form.addEventListener('submit', function(e) {
          const password = (passwordInput as HTMLInputElement).value;
          const confirmPassword = confirmPasswordInput.value;

          // V√©rification de la correspondance des mots de passe
          if (password !== confirmPassword) {
            e.preventDefault();
            showError('Les mots de passe ne correspondent pas.');
            confirmPasswordInput.focus();
            return false;
          }

          // V√©rification de la longueur minimale du mot de passe
          if (password.length < 8) {
            e.preventDefault();
            showError('Le mot de passe doit contenir au moins 8 caract√®res.');
            passwordInput.focus();
            return false;
          }

          // D√©sactiver le bouton de soumission pour √©viter les doubles soumissions
          (submitBtn as HTMLButtonElement).disabled = true;
          const submitBtnText = document.getElementById('submitBtnText');
          if (submitBtnText) submitBtnText.textContent = 'Inscription en cours...';
          submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

          // Si tout est bon, le formulaire sera soumis
        });
      }
    });
  </script>
</Layout>